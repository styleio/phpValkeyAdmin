<?php
declare(strict_types=1);

// Load configuration
$CONFIG = require __DIR__ . '/config.php';

// Utilities
function h($s): string { $flags = ENT_QUOTES; if (defined('ENT_SUBSTITUTE')) { $flags |= ENT_SUBSTITUTE; } return htmlspecialchars((string)$s, $flags, 'UTF-8'); }
function v($arr, $key, $def = null) { return array_key_exists($key, $arr) ? $arr[$key] : $def; }

// CSRF
if (session_status() === PHP_SESSION_NONE) { session_start(); }
if (empty($_SESSION['csrf'])) { $_SESSION['csrf'] = bin2hex(random_bytes(16)); }
function csrf_input(): string { return '<input type="hidden" name="csrf" value="' . h($_SESSION['csrf']) . '">'; }
function csrf_check(): void { if ($_SERVER['REQUEST_METHOD'] === 'POST') { $ok = isset($_POST['csrf']) && hash_equals($_SESSION['csrf'] ?? '', (string)$_POST['csrf']); if (!$ok) { http_response_code(400); echo 'Invalid CSRF token'; exit; } } }

// i18n loader (languages/*.php)
function load_languages(string $dir): array { $packs = []; if (!is_dir($dir)) return $packs; foreach (scandir($dir) as $f) { if ($f === '.' || $f === '..') continue; if (substr($f, -4) !== '.php') continue; $code = basename($f, '.php'); $arr = @include $dir . DIRECTORY_SEPARATOR . $f; if (is_array($arr)) $packs[$code] = $arr; } return $packs; }
function detect_lang(array $available, string $default): string { if (isset($_GET['lang']) && isset($available[$_GET['lang']])) { $_SESSION['lang'] = $_GET['lang']; setcookie('lang', $_GET['lang'], time()+31536000, '/'); return $_GET['lang']; } if (!empty($_SESSION['lang']) && isset($available[$_SESSION['lang']])) return $_SESSION['lang']; if (!empty($_COOKIE['lang']) && isset($available[$_COOKIE['lang']])) return $_COOKIE['lang']; $hdr = $_SERVER['HTTP_ACCEPT_LANGUAGE'] ?? ''; $cands = []; foreach (explode(',', $hdr) as $part) { $lang = strtolower(trim(explode(';', $part)[0] ?? '')); if ($lang === '') continue; $cands[] = $lang; if (strpos($lang, '-') !== false) $cands[] = explode('-', $lang)[0]; } foreach ($cands as $c) { if (isset($available[$c])) return $c; } return $default; }
function t(string $k): string { global $I18N, $LANG; return $I18N[$LANG][$k] ?? ($I18N['en'][$k] ?? $k); }
function ui_label(string $emoji, string $key): string { return $emoji . ' ' . t($key); }
function pretty_type_ui(string $type): string { $emap = [ 'string'=>'ğŸ”¤', 'hash'=>'#ï¸âƒ£', 'list'=>'ğŸ“œ', 'set'=>'ğŸ§©', 'zset'=>'ğŸ”¢', 'none'=>'âˆ…' ]; $emoji = $emap[$type] ?? ''; $labelKey = 'type_'.$type; $text = t($labelKey); if ($text === $labelKey) $text = $type; return trim($emoji.' '.$text); }
function format_ttl2(int $ttl): string { global $LANG; if ($ttl === -1) return 'â™¾ï¸ ' . t('permanent'); if ($ttl === -2) return t('not_available'); $s = max(0, $ttl); $d = intdiv($s, 86400); $s %= 86400; $h = intdiv($s, 3600); $s %= 3600; $m = intdiv($s, 60); $s %= 60; $parts = []; if ($LANG === 'ja') { if ($d) $parts[] = $d.'æ—¥'; if ($h) $parts[] = $h.'æ™‚'; if ($m) $parts[] = $m.'åˆ†'; if ($s || !$parts) $parts[] = $s.'ç§’'; } else { if ($d) $parts[] = $d.'d'; if ($h) $parts[] = $h.'h'; if ($m) $parts[] = $m.'m'; if ($s || !$parts) $parts[] = $s.'s'; } return 'â³ '.implode(' ', $parts); }

// Minimal Redis client
class MiniRedis {
    private $ext; private $sock; private array $cfg; public function __construct(array $cfg){$this->cfg=$cfg;}
    public function connect(): void { if (class_exists('Redis')) { $this->ext = new Redis(); $timeout=(float)($this->cfg['timeout']??1.5); if (!@$this->ext->connect($this->cfg['host'], (int)$this->cfg['port'], $timeout)) throw new RuntimeException('Unable to connect via phpredis'); if (!empty($this->cfg['password'])) { if (!$this->ext->auth($this->cfg['password'])) throw new RuntimeException('AUTH failed'); } $db=(int)($this->cfg['database']??0); if ($db !== 0) { if (!$this->ext->select($db)) throw new RuntimeException('SELECT failed'); } return; } $timeout=(float)($this->cfg['timeout']??1.5); $this->sock=@fsockopen($this->cfg['host'], (int)$this->cfg['port'], $errno, $errstr, $timeout); if (!$this->sock) throw new RuntimeException('Socket connect failed: '.$errno.' '.$errstr); stream_set_timeout($this->sock, (int)ceil($timeout)); if (!empty($this->cfg['password'])) $this->cmd(['AUTH',(string)$this->cfg['password']]); $db=(int)($this->cfg['database']??0); if ($db !== 0) $this->cmd(['SELECT',(string)$db]); }
    public function close(): void { if ($this->ext) { @$this->ext->close(); return; } if (is_resource($this->sock)) fclose($this->sock); }
    private function write(string $buf): void { $len=strlen($buf); $sent=0; while ($sent<$len) { $n=fwrite($this->sock, substr($buf,$sent)); if ($n===false) throw new RuntimeException('Socket write failed'); $sent+=$n; } }
    private function readLine(): string { $line=fgets($this->sock); if ($line===false) throw new RuntimeException('Socket read failed'); return rtrim($line, "\r\n"); }
    private function readResp(){ $line=$this->readLine(); $type=$line[0]; $payload=substr($line,1); switch($type){ case '+': return $payload; case '-': throw new RuntimeException('Redis error: '.$payload); case ':': return (int)$payload; case '$': $len=(int)$payload; if ($len===-1) return null; $data=''; $remaining=$len+2; while (strlen($data)<$remaining){ $chunk=fread($this->sock,$remaining-strlen($data)); if ($chunk===false) throw new RuntimeException('Socket bulk read failed'); $data.=$chunk; } return substr($data,0,-2); case '*': $count=(int)$payload; if ($count===-1) return null; $arr=[]; for ($i=0;$i<$count;$i++){ $arr[]=$this->readResp(); } return $arr; default: throw new RuntimeException('Unknown RESP type: '.$type);} }
    private function cmd(array $parts){ if ($this->ext) { if (method_exists($this->ext,'rawCommand')) return $this->ext->rawCommand(...$parts); $cmd=strtoupper($parts[0]); $a=array_slice($parts,1); switch($cmd){ case 'PING':return $this->ext->ping(); case 'INFO':return $this->ext->info(); case 'DBSIZE':return $this->ext->dbSize(); case 'GET':return $this->ext->get($a[0]??''); case 'SET':return $this->ext->set($a[0]??'',$a[1]??''); case 'HGETALL':return $this->ext->hGetAll($a[0]??''); case 'HSET':return $this->ext->hSet($a[0]??'',$a[1]??'',$a[2]??''); case 'HDEL':return $this->ext->hDel($a[0]??'',$a[1]??''); case 'LRANGE':return $this->ext->lRange($a[0]??'',(int)($a[1]??0),(int)($a[2]??-1)); case 'RPUSH':return $this->ext->rPush($a[0]??'',$a[1]??''); case 'LREM':return $this->ext->lRem($a[0]??'',(int)($a[1]??0),$a[2]??''); case 'SMEMBERS':return $this->ext->sMembers($a[0]??''); case 'SADD':return $this->ext->sAdd($a[0]??'',$a[1]??''); case 'SREM':return $this->ext->sRem($a[0]??'',$a[1]??''); case 'ZADD':return $this->ext->zAdd($a[0]??'',(float)($a[1]??0),$a[2]??''); case 'ZREM':return $this->ext->zRem($a[0]??'',$a[1]??''); case 'DEL':return $this->ext->del($a[0]??''); case 'RENAME':return $this->ext->rename($a[0]??'',$a[1]??''); case 'EXPIRE':return $this->ext->expire($a[0]??'',(int)($a[1]??0)); case 'PERSIST':return $this->ext->persist($a[0]??''); case 'TTL':return $this->ext->ttl($a[0]??''); case 'PTTL':return $this->ext->pttl($a[0]??''); case 'TYPE':return $this->ext->type($a[0]??''); case 'FLUSHDB':return $this->ext->flushDB(); default: throw new RuntimeException('Unsupported command without rawCommand: '.$cmd);} } $req="*".count($parts)."\r\n"; foreach($parts as $p){ $ps=(string)$p; $req.="$".strlen($ps)."\r\n".$ps."\r\n"; } $this->write($req); return $this->readResp(); }
    public function scan(string $cursor,string $pattern,int $count): array { if ($this->ext) { $it = ($cursor==='0'||$cursor==='') ? null : (int)$cursor; $this->ext->setOption(Redis::OPT_SCAN, Redis::SCAN_RETRY); $keys = $this->ext->scan($it,$pattern,$count) ?: []; return [($it===null)?'0':(string)$it,$keys]; } $resp=$this->cmd(['SCAN',$cursor,'MATCH',$pattern,'COUNT',(string)$count]); return [$resp[0],$resp[1]]; }
    public function type(string $key): string { if ($this->ext) { $code=$this->ext->type($key); $map=[Redis::REDIS_NOT_FOUND=>'none',Redis::REDIS_STRING=>'string',Redis::REDIS_SET=>'set',Redis::REDIS_LIST=>'list',Redis::REDIS_ZSET=>'zset',Redis::REDIS_HASH=>'hash']; if (is_int($code) && isset($map[$code])) return $map[$code]; } return (string)$this->cmd(['TYPE',$key]); }
    public function ttl(string $key): int { return $this->ext ? (int)$this->ext->ttl($key) : (int)$this->cmd(['TTL',$key]); }
    public function get(string $key): ?string { $r=$this->cmd(['GET',$key]); return $r===null?null:(string)$r; }
    public function set(string $key,string $val): bool { return $this->cmd(['SET',$key,$val])==='OK'; }
    public function hgetall(string $key): array { $flat=$this->cmd(['HGETALL',$key])?:[]; $res=[]; for($i=0;$i<count($flat);$i+=2){ $res[(string)$flat[$i]]=(string)$flat[$i+1]; } return $res; }
    public function hset(string $key,string $field,string $val): int { return (int)$this->cmd(['HSET',$key,$field,$val]); }
    public function hdel(string $key,string $field): int { return (int)$this->cmd(['HDEL',$key,$field]); }
    public function lrange(string $key,int $start,int $stop): array { return $this->cmd(['LRANGE',$key,(string)$start,(string)$stop])?:[]; }
    public function rpush(string $key,string $val): int { return (int)$this->cmd(['RPUSH',$key,$val]); }
    public function lrem(string $key,int $count,string $val): int { return (int)$this->cmd(['LREM',$key,(string)$count,$val]); }
    public function smembers(string $key): array { return $this->cmd(['SMEMBERS',$key])?:[]; }
    public function sadd(string $key,string $val): int { return (int)$this->cmd(['SADD',$key,$val]); }
    public function srem(string $key,string $val): int { return (int)$this->cmd(['SREM',$key,$val]); }
    public function zrangeWithScores(string $key,int $start,int $stop): array { if ($this->ext) { $arr=$this->ext->zRange($key,$start,$stop,true)?:[]; $res=[]; foreach($arr as $m=>$s){ $res[(string)$m]=(float)$s; } return $res; } $flat=$this->cmd(['ZRANGE',$key,(string)$start,(string)$stop,'WITHSCORES']); if(!is_array($flat)) $flat=[]; $res=[]; for($i=0;$i<count($flat);$i+=2){ $res[(string)$flat[$i]]=(float)$flat[$i+1]; } return $res; }
    public function zadd(string $key,float $score,string $member): int { return (int)$this->cmd(['ZADD',$key,(string)$score,$member]); }
    public function zrem(string $key,string $member): int { return (int)$this->cmd(['ZREM',$key,$member]); }
    public function info(): array { $raw=$this->cmd(['INFO']); if (is_array($raw)) return $raw; $out=[]; foreach(explode("\n",(string)$raw) as $line){ $line=trim($line); if($line===''||$line[0]==='#') continue; $parts=explode(':',$line,2); if(count($parts)===2) $out[$parts[0]]=$parts[1]; } return $out; }
    public function dbsize(): int { return (int)$this->cmd(['DBSIZE']); }
    public function del(string $key): int { return (int)$this->cmd(['DEL',$key]); }
    public function rename(string $src,string $dst): bool { return $this->cmd(['RENAME',$src,$dst])==='OK'; }
    public function expire(string $key,int $sec): bool { return (int)$this->cmd(['EXPIRE',$key,(string)$sec])===1; }
    public function persist(string $key): bool { return (int)$this->cmd(['PERSIST',$key])===1; }
    public function flushdb(): bool { return $this->cmd(['FLUSHDB'])==='OK'; }
}

// Routing and i18n setup
$serverIndex=(int)($_GET['server']??0); $servers=$CONFIG['servers']??[]; if(!isset($servers[$serverIndex])) $serverIndex=0; $server=$servers[$serverIndex];
$db=isset($_GET['db'])?(int)$_GET['db']:(int)($server['database']??0); $pattern=$_GET['pattern']??'*'; $pageSize=(int)($CONFIG['page_size']??100); $scanCount=(int)($CONFIG['scan_count']??max(50,$pageSize)); $cursor=$_GET['cursor']??'0';
$langDir=$CONFIG['languages_path'] ?? (__DIR__.'/languages'); $I18N=load_languages($langDir); if (empty($I18N['en'])) { $I18N['en']=['name'=>'English','app_title'=>'phpValkeyAdmin','server'=>'Server','db'=>'DB','switch'=>'Switch','keys'=>'Keys','create'=>'Create','info'=>'Info','search_pattern'=>'Search pattern','search'=>'Search','flushdb'=>'FLUSHDB','confirm_flushdb'=>'Are you sure to FLUSHDB?','table_key'=>'Key','table_type'=>'Type','table_ttl'=>'TTL','table_actions'=>'Actions','view'=>'View','delete'=>'Delete','confirm_delete'=>'Delete this key?','next_page'=>'Next','end_results'=>'End of results','type_label'=>'Type','ttl_label'=>'TTL','rename'=>'Rename','set_ttl'=>'Set TTL','save'=>'Save','add_update_field'=>'Add/Update Field','field'=>'Field','value'=>'Value','items_first'=>'Items (first 200)','append_item'=>'Append item','members'=>'Members','add_member'=>'Add member','member'=>'Member','score'=>'Score','unsupported'=>'Unsupported or empty type','create_key'=>'Create Key','initial_value'=>'Initial Value','server_info'=>'Server Info','dbsize'=>'dbsize','last_page'=>'Last page reached','language'=>'Language','permanent'=>'Permanent','not_available'=>'N/A','type_string'=>'string','type_hash'=>'hash','type_list'=>'list','type_set'=>'set','type_zset'=>'zset','type_none'=>'none']; }
$defaultLang=$CONFIG['default_language']??'en'; $LANG=detect_lang($I18N, isset($I18N[$defaultLang])?$defaultLang:'en');

// Connect
$r=new MiniRedis(array_merge($server,['database'=>$db])); try { $r->connect(); } catch (Throwable $e) { http_response_code(500); echo '<h1>Connection error</h1><pre>'.h($e->getMessage()).'</pre>'; exit; }
csrf_check(); $action=$_GET['action']??'list';
function redirect(string $url): void { header('Location: '.$url); exit; }
function baseUrl(array $params=[]): string { $q=array_merge(['server'=>$_GET['server']??0,'db'=>$_GET['db']??0,'lang'=>$_GET['lang']??($GLOBALS['LANG']??'en')],$params); return '?'.http_build_query($q); }

// POST actions
try {
    if ($_SERVER['REQUEST_METHOD'] === 'POST') {
        if ($action === 'set-string') { $key=(string)$_POST['key']; $val=(string)($_POST['value']??''); $r->set($key,$val); redirect(baseUrl(['action'=>'view','key'=>$key])); }
        if ($action === 'hset') { $key=(string)$_POST['key']; $field=(string)$_POST['field']; $val=(string)$_POST['value']; $r->hset($key,$field,$val); redirect(baseUrl(['action'=>'view','key'=>$key])); }
        if ($action === 'hdel') { $key=(string)$_POST['key']; $field=(string)$_POST['field']; $r->hdel($key,$field); redirect(baseUrl(['action'=>'view','key'=>$key])); }
        if ($action === 'list-add') { $key=(string)$_POST['key']; $val=(string)$_POST['value']; $r->rpush($key,$val); redirect(baseUrl(['action'=>'view','key'=>$key])); }
        if ($action === 'list-rem') { $key=(string)$_POST['key']; $val=(string)$_POST['value']; $r->lrem($key,0,$val); redirect(baseUrl(['action'=>'view','key'=>$key])); }
        if ($action === 'set-add') { $key=(string)$_POST['key']; $val=(string)$_POST['value']; $r->sadd($key,$val); redirect(baseUrl(['action'=>'view','key'=>$key])); }
        if ($action === 'set-rem') { $key=(string)$_POST['key']; $val=(string)$_POST['value']; $r->srem($key,$val); redirect(baseUrl(['action'=>'view','key'=>$key])); }
        if ($action === 'zadd') { $key=(string)$_POST['key']; $score=(float)$_POST['score']; $member=(string)$_POST['member']; $r->zadd($key,$score,$member); redirect(baseUrl(['action'=>'view','key'=>$key])); }
        if ($action === 'zrem') { $key=(string)$_POST['key']; $member=(string)$_POST['member']; $r->zrem($key,$member); redirect(baseUrl(['action'=>'view','key'=>$key])); }
        if ($action === 'create') { $key=(string)$_POST['key']; $type=(string)$_POST['type']; $value=(string)($_POST['value']??''); switch($type){ case 'string': $r->set($key,$value); break; case 'hash': $r->hset($key,'field',$value); break; case 'list': $r->rpush($key,$value); break; case 'set': $r->sadd($key,$value); break; case 'zset': $r->zadd($key,(float)($_POST['score']??0),$value); break; } redirect(baseUrl(['action'=>'view','key'=>$key])); }
        if ($action === 'delete') { $key=(string)$_POST['key']; $r->del($key); redirect(baseUrl()); }
        if ($action === 'rename') { $key=(string)$_POST['key']; $new=(string)$_POST['new']; $r->rename($key,$new); redirect(baseUrl(['action'=>'view','key'=>$new])); }
        if ($action === 'expire') { $key=(string)$_POST['key']; $ttl=(int)$_POST['ttl']; if ($ttl>0) $r->expire($key,$ttl); else $r->persist($key); redirect(baseUrl(['action'=>'view','key'=>$key])); }
        if ($action === 'flushdb' && !empty($CONFIG['allow_flush'])) { $r->flushdb(); redirect(baseUrl()); }
    }
} catch (Throwable $e) { http_response_code(500); echo '<h1>Error</h1><pre>'.h($e->getMessage()).'</pre>'; $r->close(); exit; }

// Header
function headerNav(array $servers,int $serverIndex,int $db): void { echo '<div class="toolbar">'; echo '<strong>'.h(t('app_title')).'</strong>'; echo '<form method="get" style="display:inline;margin:0">'; echo ' ğŸ–¥ï¸ '.h(t('server')).': <select name="server" onchange="this.form.submit()">'; foreach($servers as $i=>$s){ $sel=$i===$serverIndex?' selected':''; echo '<option value="'.h((string)$i).'"'.$sel.'>'.h($s['name'] ?? ($s['host'].':'.$s['port'])).'</option>'; } echo '</select>'; echo ' ğŸ—„ï¸ '.h(t('db')).': <input type="number" name="db" value="'.h($db).'" min="0" max="1024" style="width:64px">'; echo ' <button class="btn btn-small" type="submit">'.h(t('switch')).'</button>'; echo '</form>'; echo ' <a class="btn btn-small" href="'.h(baseUrl()).'">'.h(ui_label('ğŸ—ï¸','keys')).'</a>'; echo ' <a class="btn btn-small" href="'.h(baseUrl(['action'=>'create'])).'">'.h(ui_label('â•','create')).'</a>'; echo ' <a class="btn btn-small" href="'.h(baseUrl(['action'=>'info'])).'">'.h(ui_label('â„¹ï¸','info')).'</a>'; echo ' <span class="muted">ğŸŒ '.h(t('language')).':</span> '; $packs=$GLOBALS['I18N'] ?? []; $current=$GLOBALS['LANG'] ?? 'en'; foreach($packs as $code=>$pack){ $active=($code===$current); $label=$pack['name'] ?? strtoupper($code); echo '<a class="btn btn-small'.($active?' btn-secondary':'').'" href="'.h(baseUrl(['lang'=>$code])).'">'.h($label).'</a> '; } echo '</div>'; }
function footerNote(){ echo '<div style="padding:10px;color:#888;font-size:12px;border-top:1px solid #eee;margin-top:20px">Powered by phpValkeyAdmin</div>'; }

// Render
echo '<!doctype html><html><head><meta charset="utf-8"><title>phpValkeyAdmin</title>'; echo '<meta name="viewport" content="width=device-width, initial-scale=1">'; echo '<link rel="stylesheet" href="assets/style.css">'; echo '<script src="assets/app.js" defer></script>'; echo '</head><body>';
headerNav($servers,$serverIndex,$db);

if ($action === 'list') { $pattern=$_GET['pattern']??'*'; echo '<div style="padding:10px">'; echo '<form method="get" style="margin-bottom:10px">'; echo '<input type="hidden" name="server" value="'.h((string)$serverIndex).'">'; echo '<input type="hidden" name="db" value="'.h((string)$db).'">'; echo 'ğŸ” '.h(t('search_pattern')).': <input type="text" name="pattern" value="'.h($pattern).'" placeholder="user:*" style="width:320px"> '; echo '<button class="btn" type="submit">'.h(t('search')).'</button> '; echo '</form>'; if (!empty($CONFIG['allow_flush'])) { echo '<form class="inline" method="post" action="'.h(baseUrl(['action'=>'flushdb'])).'" onsubmit="return confirm(\''.h(t('confirm_flushdb')).'\')">'.csrf_input().'<button class="btn btn-danger" type="submit">ğŸ§¹ '.h(t('flushdb')).'</button></form>'; } $cursor=$_GET['cursor']??'0'; try{ [$nextCursor,$keys]=$r->scan($cursor,$pattern,$scanCount);}catch(Throwable $e){ $nextCursor='0'; $keys=[]; echo '<div class="muted">SCAN error: '.h($e->getMessage()).'</div>'; } echo '<table><tr><th>ğŸ”‘ '.h(t('table_key')).'</th><th>ğŸ“¦ '.h(t('table_type')).'</th><th>â±ï¸ '.h(t('table_ttl')).'</th><th>âš™ï¸ '.h(t('table_actions')).'</th></tr>'; foreach($keys as $k){ try{$tpe=$r->type($k);}catch(Throwable $e){$tpe='?';} try{$ttl=$r->ttl($k);}catch(Throwable $e){$ttl=-2;} $ttlStr=format_ttl2($ttl); echo '<tr>'; echo '<td class="key">'.h($k).'</td>'; echo '<td><span class="badge">'.h(pretty_type_ui($tpe)).'</span></td>'; echo '<td>'.h($ttlStr).'</td>'; echo '<td>'; echo '<a class="btn btn-small" href="'.h(baseUrl(['action'=>'view','key'=>$k])).'">'.h(ui_label('ğŸ‘ï¸','view')).'</a> '; echo '<form class="inline" method="post" action="'.h(baseUrl(['action'=>'delete'])).'" onsubmit="return confirm(\''.h(t('confirm_delete')).'\')">'.csrf_input().'<input type="hidden" name="key" value="'.h($k).'"><button class="btn btn-danger btn-small" type="submit">'.h(ui_label('ğŸ—‘ï¸','delete')).'</button></form>'; echo '</td>'; echo '</tr>'; } echo '</table>'; echo '<div style="margin-top:8px">'; if(!empty($nextCursor) && $nextCursor!=='0'){ echo '<a class="btn btn-small" href="'.h(baseUrl(['pattern'=>$pattern,'cursor'=>$nextCursor])).'">'.h(ui_label('â–¶ï¸','next_page')).'</a>'; } else { echo '<span class="muted">'.h(t('end_results')).'</span>'; } echo '</div>'; echo '</div>'; }

if ($action === 'view') { $key=(string)($_GET['key']??''); echo '<div style="padding:10px">'; echo '<h2 class="key">'.h($key).'</h2>'; try{$type=$r->type($key);}catch(Throwable $e){$type='?';} try{$ttl=$r->ttl($key);}catch(Throwable $e){$ttl=-2;} $ttlStr=format_ttl2($ttl); echo '<div class="muted">ğŸ“¦ '.h(t('type_label')).': <span class="badge">'.h(pretty_type_ui($type)).'</span> | â±ï¸ '.h(t('ttl_label')).': '.h($ttlStr).'</div>'; echo '<div style="margin:10px 0">'; echo '<form class="inline" method="post" action="'.h(baseUrl(['action'=>'rename'])).'">'.csrf_input().'<input type="hidden" name="key" value="'.h($key).'"><input type="text" name="new" value="'.h($key).'" style="width:300px"> <button class="btn btn-small" type="submit">'.h(ui_label('âœï¸','rename')).'</button></form> '; echo '<form class="inline" method="post" action="'.h(baseUrl(['action'=>'expire'])).'">'.csrf_input().'<input type="hidden" name="key" value="'.h($key).'"><input type="number" name="ttl" placeholder="'.h(($LANG==='ja')?'ç§’ (0 ã§æ°¸ç¶š)':'seconds (0=persist)').'" style="width:160px"> <button class="btn btn-small" type="submit">'.h(ui_label('â±ï¸','set_ttl')).'</button></form> '; echo '<form class="inline" method="post" action="'.h(baseUrl(['action'=>'delete'])).'" onsubmit="return confirm(\''.h(t('confirm_delete')).'\')">'.csrf_input().'<input type="hidden" name="key" value="'.h($key).'"><button class="btn btn-danger btn-small" type="submit">'.h(ui_label('ğŸ—‘ï¸','delete')).'</button></form>'; echo '</div>'; if($type==='string'){ $val=(string)($r->get($key)??''); echo '<form method="post" action="'.h(baseUrl(['action'=>'set-string'])).'">'.csrf_input().'<input type="hidden" name="key" value="'.h($key).'">'; echo '<textarea name="value" rows="10" style="font-family:monospace">'.h($val).'</textarea><br>'; echo '<button class="btn" type="submit">'.h(ui_label('ğŸ’¾','save')).'</button>'; echo '</form>'; } elseif($type==='hash'){ $fields=$r->hgetall($key); echo '<table><tr><th>ğŸ·ï¸ '.h(t('field')).'</th><th>ğŸ“„ '.h(t('value')).'</th><th>âš™ï¸ '.h(t('table_actions')).'</th></tr>'; foreach($fields as $f=>$v){ echo '<tr><td class="key">'.h($f).'</td><td><pre style="white-space:pre-wrap;margin:0">'.h($v).'</pre></td><td>'; echo '<form class="inline" method="post" action="'.h(baseUrl(['action'=>'hdel'])).'">'.csrf_input().'<input type="hidden" name="key" value="'.h($key).'"><input type="hidden" name="field" value="'.h($f).'"><button class="btn btn-danger btn-small" type="submit">'.h(ui_label('ğŸ—‘ï¸','delete')).'</button></form>'; echo '</td></tr>'; } echo '</table>'; echo '<h3>â• '.h(t('add_update_field')).'</h3>'; echo '<form method="post" action="'.h(baseUrl(['action'=>'hset'])).'">'.csrf_input().'<input type="hidden" name="key" value="'.h($key).'">'; echo h(t('field')).' <input type="text" name="field" style="width:200px"> '.h(t('value')).' <input type="text" name="value" style="width:400px"> <button class="btn" type="submit">'.h(ui_label('ğŸ’¾','save')).'</button>'; echo '</form>'; } elseif($type==='list'){ $items=$r->lrange($key,0,200); echo '<h3>ğŸ“œ '.h(t('items_first')).'</h3><ul>'; foreach($items as $v){ echo '<li><code>'.h($v).'</code> '; echo '<form class="inline" method="post" action="'.h(baseUrl(['action'=>'list-rem'])).'">'.csrf_input().'<input type="hidden" name="key" value="'.h($key).'"><input type="hidden" name="value" value="'.h($v).'"><button class="btn btn-danger btn-small" type="submit">'.h(ui_label('ğŸ—‘ï¸','delete')).'</button></form>'; echo '</li>'; } echo '</ul>'; echo '<h3>â• '.h(t('append_item')).'</h3>'; echo '<form method="post" action="'.h(baseUrl(['action'=>'list-add'])).'">'.csrf_input().'<input type="hidden" name="key" value="'.h($key).'">'; echo '<input type="text" name="value" style="width:400px"> <button class="btn" type="submit">'.h(ui_label('â¡ï¸','button_rpush')).'</button>'; echo '</form>'; } elseif($type==='set'){ $members=$r->smembers($key); sort($members,SORT_STRING); echo '<h3>ğŸ§© '.h(t('members')).'</h3><ul>'; foreach($members as $m){ echo '<li><code>'.h($m).'</code> '; echo '<form class="inline" method="post" action="'.h(baseUrl(['action'=>'set-rem'])).'">'.csrf_input().'<input type="hidden" name="key" value="'.h($key).'"><input type="hidden" name="value" value="'.h($m).'"><button class="btn btn-danger btn-small" type="submit">'.h(ui_label('ğŸ—‘ï¸','delete')).'</button></form>'; echo '</li>'; } echo '</ul>'; echo '<h3>â• '.h(t('add_member')).'</h3>'; echo '<form method="post" action="'.h(baseUrl(['action'=>'set-add'])).'">'.csrf_input().'<input type="hidden" name="key" value="'.h($key).'">'; echo '<input type="text" name="value" style="width:400px"> <button class="btn" type="submit">'.h(ui_label('â•','button_sadd')).'</button>'; echo '</form>'; } elseif($type==='zset'){ $pairs=$r->zrangeWithScores($key,0,200); echo '<h3>ğŸ§® '.h(t('members')).' (first 200)</h3>'; echo '<table><tr><th>'.h(t('member')).'</th><th>'.h(t('score')).'</th><th>'.h(t('table_actions')).'</th></tr>'; foreach($pairs as $member=>$score){ echo '<tr><td><code>'.h($member).'</code></td><td>'.h((string)$score).'</td><td>'; echo '<form class="inline" method="post" action="'.h(baseUrl(['action'=>'zrem'])).'">'.csrf_input().'<input type="hidden" name="key" value="'.h($key).'"><input type="hidden" name="member" value="'.h($member).'"><button class="btn btn-danger btn-small" type="submit">'.h(ui_label('ğŸ—‘ï¸','delete')).'</button></form>'; echo '</td></tr>'; } echo '</table>'; echo '<h3>â• '.h(t('add_member')).'</h3>'; echo '<form method="post" action="'.h(baseUrl(['action'=>'zadd'])).'">'.csrf_input().'<input type="hidden" name="key" value="'.h($key).'">'; echo h(t('member')).' <input type="text" name="member" style="width:300px"> '.h(t('score')).' <input type="number" step="any" name="score" value="0" style="width:120px"> <button class="btn" type="submit">'.h(ui_label('â•','button_zadd')).'</button>'; echo '</form>'; } else { echo '<div class="muted">'.h(t('unsupported')).': '.h($type).'</div>'; } echo '</div>'; }

if ($action === 'create') { echo '<div style="padding:10px">'; echo '<h2>â• '.h(t('create_key')).'</h2>'; echo '<form method="post" action="'.h(baseUrl(['action'=>'create'])).'">'.csrf_input(); echo 'Key <input type="text" name="key" style="width:300px" required> '; echo 'Type <select name="type"><option>string</option><option>hash</option><option>list</option><option>set</option><option>zset</option></select><br><br>'; echo h(t('initial_value')).' <input type="text" name="value" style="width:400px"> '.h(t('score')).' (zset) <input type="number" step="any" name="score" value="0" style="width:120px"><br><br>'; echo '<button class="btn" type="submit">'.h(t('button_create')).'</button>'; echo '</form>'; echo '</div>'; }

if ($action === 'info') { $info=$r->info(); $dbsize=$r->dbsize(); echo '<div style="padding:10px">'; echo '<h2>â„¹ï¸ '.h(t('server_info')).'</h2>'; echo '<table>'; echo '<tr><th>'.h(t('table_key')).'</th><th>'.h(t('value')).'</th></tr>'; foreach($info as $k=>$v){ echo '<tr><td>'.h($k).'</td><td>'.h(is_array($v)?json_encode($v):$v).'</td></tr>'; } echo '<tr><td>'.h(t('dbsize')).'</td><td>'.h((string)$dbsize).'</td></tr>'; echo '</table>'; echo '</div>'; }

$r->close(); footerNote(); echo '</body></html>';


